# Protocol2USDM

> ## âš ï¸ Disclaimer: An Experiment in AI-Assisted Development
>
> **This project was built with one self-imposed rule:** *I would not write or edit a single line of code myself.*
>
> The goal was to answer a simple question:
>
> > *"Can someone with no coding experience build production-quality clinical software using only AI assistants?"*
>
> Every line of code in this repository was generated by AI coding assistants (Claude, GPT, Gemini). The human role was limited to:
> - Describing requirements and desired outcomes
> - Reviewing and approving AI-generated code
> - Providing feedback and requesting corrections
> - Testing functionality and reporting issues
>
> **As a result, this software:**
> - âŒ Is **not robust** â€” edge cases may not be handled
> - âŒ Is **likely full of bugs** â€” limited systematic testing
> - âŒ Has **not been thoroughly tested** â€” no formal QA process
> - âŒ Is **NOT fit for any production environment**
> - âŒ Should **NOT be used for actual clinical trials or regulatory submissions**
>
> **This project exists solely as:**
> - âœ… A **demonstrator** of AI-assisted development capabilities
> - âœ… A **reference implementation** of USDM v4.0 extraction concepts
> - âœ… An **experiment** in human-AI collaboration for software development
>
> *Use at your own risk. Contributions and improvements welcome.*

---

**Extract clinical protocol content into USDM v4.0 format**

Protocol2USDM is an automated pipeline that extracts, validates, and structures clinical trial protocol content into data conformant to the [CDISC USDM v4.0](https://www.cdisc.org/standards/foundational/usdm) model.

---

## ğŸš€ Try It Now

```bash
# Full extraction with SAP, sites, parallel execution
python main_v3.py input/trial/NCT04573309_Wilsons/NCT04573309_Wilsons_Protocol.pdf \
  --complete \
  --sap input/trial/NCT04573309_Wilsons/NCT04573309_Wilsons_SAP.pdf \
  --sites input/trial/NCT04573309_Wilsons/NCT04573309_Wilsons_sites.csv \
  --parallel \
  --model gemini-3-flash
```

This extracts the full protocol with execution model, enriches entities with NCI terminology codes, includes SAP analysis populations (with STATO mapping and ARS linkage), and site list.

> **ğŸ’¡ Default Model:** `gemini-3-flash-preview` (Gemini Flash 3) via Vertex AI with `gemini-2.5-pro` as fallback. These are the only models currently optimised and tested. Provider hooks for OpenAI and Anthropic models exist but are **not yet tuned** â€” they are reserved for future support. The pipeline defaults to `--complete` mode when no specific phases are requested.

### âš ï¸ Important: Vertex AI Requirement for Gemini

Gemini models must be accessed via **Google Cloud Vertex AI** (not AI Studio) to properly disable safety controls. The consumer API (AI Studio) may still block or restrict medical/clinical content even with safety settings disabled. Vertex AI allows `BLOCK_NONE` safety settings which are essential for clinical protocol extraction.

**Required `.env` configuration for Gemini via Vertex AI:**
```bash
GOOGLE_CLOUD_PROJECT=your-project-id
GOOGLE_CLOUD_LOCATION=us-central1  # or your preferred region
```

---

## What's New in v8.0

### âš™ï¸ CORE Compliance: Log-Only Audit Mode
Property stripping (`_walk_strip_non_usdm`) replaced with **non-destructive audit** â€” non-USDM properties are kept in the output and findings saved to `compliance_log.json`. New **Compliance Audit card** in the Validation tab shows findings grouped by entity type.

### ğŸ”— Encounterâ†’Epoch Resolution (USDM v4.0)
USDM v4.0 encounters linked via `ScheduledActivityInstance` bridge â€” SoA table, graph view, and quality dashboard all resolved.

### ğŸï¸ UNS Detached Handling
Unscheduled visits rendered as **isolated islands** in graph view and state machine (detached with annotation).

### ğŸ”§ UI Data Display Refinements
- **Randomization** â€” read from `subTypes[]` via CDISC C-codes (C25196/C48660)
- **Substance type/description** â€” derived from linked `StudyIntervention` by name matching
- **Amendment changes** â€” human-readable text instead of raw JSON objects
- **Procedures filter** â€” skip non-clinical activities (dosing, diet, consent) in pipeline + UI
- **Footnote numbering** â€” changed from letters `[a],[b]` to numeric `[1],[2]`
- **InterventionsView** â€” aligned to USDM v4.0 nested `AdministrableProduct` structure
- **Estimands** â€” resolve `interventionIds`â†’names, `variableOfInterestId`â†’endpoint name
- **Boolean fields** â€” show â€œYesâ€/â€œNoâ€ instead of raw `true`/`false`

### âš™ï¸ CDISC CORE Compliance
- 11 automated CORE rule fixes in post-processing
- **Administrations** nested inside `StudyIntervention` per schema
- **blindingSchema** output as proper `AliasCode` with `standardCode`
- **Activity groups** promoted to parent `Activity` with `childIds`

### ğŸ›¡ï¸ USDM Schema Compliance (v8.0.1â€“v8.0.2)
- **FIX-1â€“FIX-5**: 5 architectural fixes eliminating ~88% of schema validation errors across 34 trials
- **CORE property cleanup**: Removed 4 non-USDM properties (`doseFrequency`, `studyPhase` on version, `administrationIds`, `cohortIds`)
- **Estimandâ†’Endpoint reconciliation**: `variableOfInterestId` matched to real endpoint IDs via name/level/fuzzy matching

### ğŸ§ª Testing
- **1117 tests** passed, 0 failures

<details>
<summary><b>v7.17 â€” Reviewer Fixes P3â€“P7, Org/Site Alignment, Schema Compliance</b></summary>

**Reviewer Fixes P3â€“P7: USDM Structural Compliance** â€” `ensure_eos_study_cell()`, `nest_sites_in_organizations()`, `wire_document_layer()`, `nest_cohorts_in_population()`, `promote_footnotes_to_conditions()`

**Reviewer v9: Organization & StudySite Schema Alignment** â€” `studySites` removed from studyDesign (not a USDM path), sites only in `Organization.managedSites[]`, required org fields backfilled, ISO 3166-1 alpha-3 country codes, site-org mapping fix, documentedBy wiring, field renames (`scheduledAtTimingIdâ†’scheduledAtId`, `environmentalSettingâ†’environmentalSettings`)

**UI & Rendering** â€” medicalDevices on studyVersion, DOCX XML sanitization, StudySitesView reads `Organization.managedSites[]` + planned enrollment, FootnotesView handles object footnotes + `studyDesign.notes[]`
</details>

<details>
<summary><b>v7.16 â€” USDM v4.0 Endpoint Nesting, ExtensionAttribute Alignment, Architectural Audit</b></summary>

- **Endpoint nesting** â€” inline inside `Objective.endpoints` per USDM v4.0
- **ExtensionAttribute** â€” `name` removed, `url` is sole semantic identifier
- **core_compliance.py** â€” 210 lines dead code removed, label/procedure fixes upstream
- 1136 tests passing
</details>

<details>
<summary><b>v7.15 â€” Review Fix Sprint (B1â€“B9), Enrollment Extraction</b></summary>

- **Phantom activity refs** â€” improved execution model prompts + orphan nullification fallback
- **Duplicate activities** â€” extended clinical synonym normalization
- **Missing StudyCells** â€” gap-fill for incomplete armÃ—epoch combinations
- **Orphan cross-refs** â€” `scopeId` and `exitEpochIds` cleanup
- **Keyword-guided enrollment** (G1) â€” regex scan â†’ focused LLM, 4-tier fallback
- 1100 tests passing
</details>

<details>
<summary><b>v7.13 â€” Graph View Neighborhood Focus & Layout Selector</b></summary>

- **Neighborhood dimming**: Click a node to dim all non-connected elements
- **Layout selector**: 6 Cytoscape layouts
- **Toolbar flex-wrap**: Actions bar wraps on narrow viewports
- 1017 tests passing
</details>

<details>
<summary><b>v7.12 â€” Procedure Codes, Graph Editing, Anchor Nodes</b></summary>

- **Procedure code enrichment** â€” automatic NCI/SNOMED/ICD-10/CPT/LOINC mapping via embedded DB + EVS API
- **Graph viewer editing** â€” inline editing with semantic patches, clickable cross-references, undo/redo
- **Dedicated anchor nodes** â€” amber diamond nodes with dashed edges to encounters
- **Timeline popout fix** â€” position-aware alignment prevents label clipping
- 981 tests passing
</details>

<details>
<summary><b>v7.11 â€” SoA Page Finder, Dangling SAI Fix, MeSH Links</b></summary>

- **SoA multi-page table detection** â€” header-fingerprint expansion Â±8 pages, wide-table heuristic
- **Dangling SAI fix** â€” post-reconciliation cleanup remaps `encounterId` to surviving encounters
- **MeSH code links** â€” clickable links to NLM MeSH Browser for therapeutic areas
- 941 tests passing
</details>

<details>
<summary><b>v7.10 â€” SAP Fixes, Timeline Anchors, Integrity Checker</b></summary>

- **3 SAP bugs fixed** â€” wrong key lookup, duplicate extensions, missing path forwarding
- **All time anchors** rendered with type-specific colors and grouped hover tooltips
- **Figure extraction** â€” three-strategy pipeline (embedded â†’ cropped â†’ full page)
- **Referential integrity checker** â€” 3-layer USDM validation with UI
- **Cross-phase context enrichment** â€” scheduling and advanced phases receive upstream context
- **AdministrableProduct expansion** â€” 5 new USDM v4.0 fields
- 939 tests passing
</details>

<details>
<summary><b>v7.9 â€” Estimands Editing, sectionType Tagging, UNS State Machine</b></summary>

- **Estimands Fully Editable (P4)** â€” All 5 ICH E9(R1) attributes editable + intercurrent events add/remove
- **M11-Aware sectionType Tagging (P15)** â€” `NarrativeContentItem` carries `sectionType` from parent section
- **Renderer Monolith Split (W-HIGH-1)** â€” `m11_renderer.py` 1199â†’465 lines
- **NarrativeContent USDM v4.0 Conformance** â€” `displaySectionTitle`, `displaySectionNumber`, `previousId`/`nextId`, `contentItemId`
- **UNS Phase 2 & 3** â€” `ScheduledDecisionInstance` + diamond decision nodes in timeline graph
- 856 tests passing
</details>

<details>
<summary><b>v7.8 â€” USDM v4.0 Gap Audit & NCI Codes</b></summary>

- **28 missing USDM fields fixed** across 3 sprints (3 CRITICAL, 10 HIGH, 9 MEDIUM, 6 LOW)
- **70+ fabricated NCI codes fixed** â€” systematic audit of 141 C-codes against NCI EVS API
- **Code Registry** â€” `core/code_registry.py` centralized singleton
- **UNS encounter tagging** â€” auto-detection + visual distinction in SoA grid
- **808 tests** passing
</details>

<details>
<summary><b>v7.4 â€” Performance & Scalability</b></summary>

- **Parallel execution model** â€” 12 independent sub-extractors run concurrently via `ThreadPoolExecutor`
- **Async LLM calls** â€” `agenerate()` / `agenerate_stream()` on all 3 providers with native async SDKs
- **LLM streaming** â€” `StreamChunk` + `StreamCallback` for real-time progress visibility
- **Chunked EVS cache** â€” Per-code JSON files (O(1) writes), auto-migration from monolithic file
- **Provenance tracking**, **prompt versioning**, **M11 mapping validation**, **SoA table rendering** overhaul
</details>

<details>
<summary><b>v7.3 â€” ICH M11 Document Rendering</b></summary>

- **M11 DOCX generation** â€” 9 entity composers, 7-pass section mapper, conformance scoring
- **Testing infrastructure** (E7â€“E13) â€” mocked LLM tests, PipelineContext tests, E2E integration
- **Pipeline decomposition** â€” combiner/integrations/post_processing/promotion
- **LLM provider abstraction** â€” `providers/` module with factory pattern
</details>

### Previous Releases

<details>
<summary><b>v7.2 â€” Execution Model Promotion</b></summary>

- **Time Anchors**: Extract temporal reference points (VISIT/EVENT/CONCEPTUAL classification)
- **Visit Windows**: Timing tolerances â†’ `Timing.windowLower/windowUpper` (ISO 8601)
- **Subject State Machine**: Subject flow â†’ `TransitionRule` on `Encounter`
- **Dosing Regimens**: Drug administration â†’ `Administration` entities
- **Repetitions**: Cycle-based patterns â†’ `ScheduledActivityInstance` expansion
- **Traversal Constraints**: Subject journey â†’ `Epoch/Encounter.previousId/nextId` chains
- **Footnote Conditions**: Conditional rules â†’ `Condition` + `ScheduledDecisionInstance`
- **Titration Schedules**: Dose escalation â†’ `StudyElement` with `TransitionRule`

**Promotion**: Execution model data promoted to **native USDM entities** instead of extensions.
</details>

<details>
<summary><b>v7.1 â€” Phase Registry Architecture</b></summary>

- **`main_v3.py`** â€” Clean phase registry pattern replacing monolithic `main_v2.py`
- **Parallel execution** â€” Run independent phases concurrently with `--parallel`
- **Default `--complete` mode** â€” Full extraction when no specific phases requested
- **Gemini Flash 3** â€” Pipeline optimized and tested with `gemini-3-flash-preview`
</details>

### ğŸ›ï¸ USDM 4.0 Alignment
- All entities placed at correct locations per CDISC `dataStructure.yml`
- Proper entity hierarchy (studyVersion, studyDesign, scheduleTimeline, activity)
- NCI code mappings for dose forms, timing types, and identifier types

---

## Features

- **Gemini Flash 3 Optimized**: Pipeline tuned for best results with `gemini-3-flash` via Vertex AI
- **Vision-Validated Extraction**: Text extraction validated against actual PDF images
- **USDM v4.0 Aligned**: Outputs follow official CDISC schema with proper entity hierarchy
- **Execution Model**: Full subject state machine, time anchors, visit windows, and dosing regimens
- **NCI Terminology Enrichment**: Automatic enrichment with official NCI codes via EVS API
- **Pipeline Context**: Each extractor receives accumulated context from prior phases
- **Entity Reconciliation**: LLM-based semantic mapping and ID preservation
- **Rich Provenance**: Every cell tagged with source (text/vision/both) for confidence tracking
- **CDISC CORE Validation**: Built-in conformance checking with local engine
- **Modern Web UI**: Complete React/Next.js protocol viewer (see below)

### Extraction Capabilities

| Module | Entities | CLI Flag |
|--------|----------|----------|
| **SoA** | Activity, PlannedTimepoint, Epoch, Encounter, CommentAnnotation | (default) |
| **Metadata** | StudyTitle, StudyIdentifier, Organization, Indication | `--metadata` |
| **Eligibility** | EligibilityCriterion, StudyDesignPopulation | `--eligibility` |
| **Objectives** | Objective, Endpoint, Estimand | `--objectives` |
| **Study Design** | StudyArm, StudyCell, StudyCohort | `--studydesign` |
| **Interventions** | StudyIntervention, AdministrableProduct, Substance | `--interventions` |
| **Narrative** | NarrativeContent, Abbreviation | `--narrative` |
| **Advanced** | StudyAmendment, GeographicScope, Country | `--advanced` |
| **Procedures** | Procedure, MedicalDevice, Ingredient, Strength | `--procedures` |
| **Scheduling** | Timing, Condition, TransitionRule, ScheduleTimelineExit | `--scheduling` |
| **Doc Structure** | NarrativeContentItem, StudyDefinitionDocument | `--docstructure` |
| **Amendments** | StudyAmendmentReason, ImpactedEntity | `--amendmentdetails` |
| **Execution Model** | TimeAnchor, VisitWindow, StateMachine, Repetition | `--execution` |

#### Conditional Sources (Additional Documents)

| Source | Entities | CLI Flag |
|--------|----------|----------|
| **SAP** | AnalysisPopulation, Characteristic | `--sap <path>` |
| **Site List** | StudySite, StudyRole, AssignedPerson | `--sites <path>` |

---

## Full Protocol Extraction

Extract everything with a single command:

```bash
# Default behavior - no flags needed! Runs --complete automatically
python main_v3.py protocol.pdf

# Explicit --complete: Full extraction + all post-processing
python main_v3.py protocol.pdf --complete

# Parallel execution for faster processing
python main_v3.py protocol.pdf --parallel --max-workers 4
```

Or select specific phases:

```bash
python main_v3.py protocol.pdf --metadata --eligibility --objectives
python main_v3.py protocol.pdf --expansion-only --metadata  # Skip SoA
python main_v3.py protocol.pdf --procedures --scheduling --execution
```

With additional source documents:

```bash
python main_v3.py protocol.pdf --sap sap.pdf --sites sites.xlsx
```

Output: Individual JSONs + combined `protocol_usdm.json`

---

## Quick Start

```bash
# 1. Clone repository
git clone https://github.com/Panikos/Protocol2USDMv3.git
cd Protocol2USDMv3

# 2. Install dependencies
pip install -r requirements.txt

# 3. Set up API keys (.env file)
GOOGLE_CLOUD_PROJECT=your-gcp-project  # Required for Gemini via Vertex AI
GOOGLE_CLOUD_LOCATION=us-central1
OPENAI_API_KEY=...      # Optional: for GPT models
CLAUDE_API_KEY=...      # Optional: for Claude models
CDISC_API_KEY=...       # Optional: for CORE conformance

# 4. Run the pipeline (defaults to --complete with gemini-3-flash-preview)
python main_v3.py input/trial/NCT04573309_Wilsons/NCT04573309_Wilsons_Protocol.pdf

# 5. View results in web UI
cd web-ui && npm run dev
```

---

## Installation

### Requirements
- Python 3.9+
- API keys: OpenAI, Google AI, Claude AI, CDISC API

### Setup

```bash
# Create virtual environment (recommended)
python -m venv venv
venv\Scripts\activate  # Windows
source venv/bin/activate  # macOS/Linux

# Install dependencies
pip install -r requirements.txt

# Create .env file with API keys
echo "OPENAI_API_KEY=sk-your-key" > .env
echo "GOOGLE_API_KEY=AIza-your-key" >> .env
echo "CDISC_API_KEY=your-cdisc-key" >> .env
```

### CDISC CORE Engine (Optional)
For conformance validation, download the CORE engine:
```bash
python tools/core/download_core.py
```

**Note:** Get your CDISC API key from https://library.cdisc.org/ (requires CDISC membership)

---

## Usage

### Basic Usage

```bash
# main_v3.py is the recommended entry point (phase registry architecture)
python main_v3.py <protocol.pdf> [options]

# Legacy main_v2.py has been removed â€” use main_v3.py
```

### Model Selection

```bash
# Default: gemini-3-flash-preview (no --model flag needed)
python main_v3.py protocol.pdf

# Gemini 2.5 Pro (tested fallback)
python main_v3.py protocol.pdf --model gemini-2.5-pro
```

### Complete Extraction (Default)

```bash
# Default behavior - runs --complete automatically when no phases specified
python main_v3.py protocol.pdf

# With SAP document for analysis populations
python main_v3.py protocol.pdf --sap sap.pdf
```

**`--complete` enables:**
| Option | Description |
|--------|-------------|
| `--full-protocol` | All 12 expansion phases (metadata, eligibility, objectives, etc.) |
| `--soa` | Full SoA extraction pipeline |
| `--enrich` | NCI terminology code enrichment |
| `--validate-schema` | USDM schema validation |
| `--conformance` | CDISC CORE conformance rules |

### Full Pipeline with Post-Processing

```bash
# Run SoA + enrichment + schema validation + CORE conformance
python main_v3.py protocol.pdf --soa

# Or run post-processing steps individually
python main_v3.py protocol.pdf --enrich              # Step 7: NCI terminology
python main_v3.py protocol.pdf --validate-schema     # Step 8: Schema validation
python main_v3.py protocol.pdf --conformance         # Step 9: CORE conformance
```

### Additional Options

```bash
--output-dir, -o           Output directory (default: output/<protocol_name>)
--pages, -p                Specific SoA page numbers (comma-separated)
--no-validate              Skip vision validation
--remove-hallucinations    Remove cells not confirmed by vision (default: keep all)
--confidence-threshold     Confidence threshold for hallucination removal (default: 0.7)
--verbose, -v              Enable verbose output
--update-evs-cache         Update EVS terminology cache before enrichment
--update-cache             Update CDISC CORE rules cache (requires CDISC_API_KEY)
```

---

## Pipeline Steps

### SoA Extraction (Steps 1-4)

| Step | Description | Output File |
|------|-------------|-------------|
| 1 | Find SoA pages & analyze header structure (vision) | `4_header_structure.json` |
| 2 | Extract SoA data from text | `5_raw_text_soa.json` |
| 3 | Validate extraction against images | `6_validation_result.json` |
| 4 | Build SoA output | `9_final_soa.json` + `9_final_soa_provenance.json` |

### Expansion Phases (with `--full-protocol`)

| Phase | Entities | Output File | CLI Flag |
|-------|----------|-------------|----------|
| Metadata | StudyTitle, Organization, Indication | `2_study_metadata.json` | `--metadata` |
| Eligibility | EligibilityCriterion, Population | `3_eligibility_criteria.json` | `--eligibility` |
| Objectives | Objective, Endpoint, Estimand | `4_objectives_endpoints.json` | `--objectives` |
| Study Design | StudyArm, StudyCell, StudyCohort | `5_study_design.json` | `--studydesign` |
| Interventions | StudyIntervention, Product, Substance | `6_interventions.json` | `--interventions` |
| Narrative | Abbreviation, NarrativeContent | `7_narrative_structure.json` | `--narrative` |
| Advanced | StudyAmendment, GeographicScope, Country | `8_advanced_entities.json` | `--advanced` |
| Procedures | Procedure, MedicalDevice, Ingredient | `9_procedures_devices.json` | `--procedures` |
| Scheduling | Timing, Condition, TransitionRule | `10_scheduling_logic.json` | `--scheduling` |
| Doc Structure | NarrativeContentItem, StudyDefinitionDocument | `13_document_structure.json` | `--docstructure` |
| Amendments | StudyAmendmentReason, ImpactedEntity | `14_amendment_details.json` | `--amendmentdetails` |
| **Execution** | TimeAnchor, Repetition, StateMachine | `11_execution_model.json` | `--execution` |

### Conditional Sources (with `--sap` or `--sites`)

| Source | Entities | Output File |
|--------|----------|-------------|
| SAP Document | AnalysisPopulation, Characteristic | `11_sap_populations.json` |
| Site List | StudySite, StudyRole, AssignedPerson | `12_study_sites.json` |

### Post-Processing

| Step | Description | Output File |
|------|-------------|-------------|
| Combine | Merge all extractions | `protocol_usdm.json` â­ |
| Terminology | NCI EVS code enrichment | `terminology_enrichment.json` |
| Schema Fix | Auto-fix schema issues (UUIDs, Codes) | `schema_validation.json` |
| USDM Validation | Validate against official USDM package | `usdm_validation.json` |
| Conformance | CDISC CORE rules validation | `conformance_report.json` |
| ID Mapping | Simple ID â†’ UUID mapping | `id_mapping.json` |
| Provenance | UUID-based provenance for viewer | `protocol_usdm_provenance.json` |

**Primary output:** `output/<protocol>/protocol_usdm.json`

---

## Output Structure

The output follows the official USDM v4.0 schema from `dataStructure.yml` with proper entity placement:

```
Study â†’ StudyVersion â†’ StudyDesign
         â”‚              â”‚
         â”‚              â”œâ”€â”€ eligibilityCriteria[]
         â”‚              â”œâ”€â”€ indications[]
         â”‚              â”œâ”€â”€ analysisPopulations[]
         â”‚              â”œâ”€â”€ activities[].definedProcedures[]
         â”‚              â””â”€â”€ scheduleTimelines[].timings[], .exits[]
         â”‚
         â”œâ”€â”€ eligibilityCriterionItems[]
         â”œâ”€â”€ organizations[]
         â”œâ”€â”€ narrativeContentItems[]
         â”œâ”€â”€ abbreviations[]
         â”œâ”€â”€ conditions[]
         â”œâ”€â”€ amendments[]
         â”œâ”€â”€ administrableProducts[]
         â”œâ”€â”€ medicalDevices[]
         â””â”€â”€ studyInterventions[]
```

For detailed output structure and entity relationships, see [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md#usdm-output-structure-v40-aligned).

### Provenance Tracking

Provenance metadata is stored separately in `9_final_soa_provenance.json` and visualized in the web UI:

| Source | Color | Meaning |
|--------|-------|---------|
| `both` | ğŸŸ© Green | Confirmed (text + vision agree) |
| `text` | ğŸŸ¦ Blue | Text-only (NOT confirmed by vision) |
| `vision` | ğŸŸ§ Orange | Vision-only (possible hallucination, needs review) |
| (none) | ğŸ”´ Red | Orphaned (no provenance data) |

View provenance in the web UI by running `cd web-ui && npm run dev`.

**Note:** By default, all text-extracted cells are kept in the output. Use `--remove-hallucinations` to exclude cells not confirmed by vision.

### SoA Footnotes

Footnotes extracted from SoA tables are stored in `StudyDesign.notes` as USDM v4.0 `CommentAnnotation` objects:

```json
"notes": [
  {"id": "soa_fn_1", "text": "a. Within 32 days of administration", "instanceType": "CommentAnnotation"},
  {"id": "soa_fn_2", "text": "b. Participants admitted 10 hours prior", "instanceType": "CommentAnnotation"}
]
```

---

## Web UI (Complete Revamp)

The web interface has been **completely revamped** from the legacy Streamlit app to a modern, user-friendly stack built with **React 19**, **Next.js 16**, **TypeScript**, **TailwindCSS**, and **AG Grid**.

### Launch the Web UI

```bash
cd web-ui
npm install
npm run dev
```

Then open http://localhost:3000 in your browser.

### Technology Stack

| Component | Technology |
|-----------|------------|
| **Framework** | Next.js 16 with App Router |
| **Language** | TypeScript |
| **Styling** | TailwindCSS with dark mode support |
| **Data Tables** | AG Grid for high-performance SoA display |
| **Visualization** | Cytoscape.js for interactive timeline graphs |
| **State Management** | Zustand |
| **Icons** | Lucide React |

### What's Visible in the Web UI

**Protocol Overview:**
- Study metadata (title, phase, indication, sponsor)
- Study identifiers (NCT, EudraCT, IND numbers)
- Amendment history

**Schedule of Activities (SoA):**
- Interactive AG Grid table with epoch/encounter groupings
- Color-coded provenance indicators (green=confirmed, blue=text-only, orange=vision-only)
- Footnote references with hover tooltips
- Activity filtering and search

**Study Design:**
- Study arms, epochs, and study cells
- Activity groups with child activity linking
- Transition rules between epochs

**Eligibility & Objectives:**
- Inclusion/exclusion criteria display
- Primary and secondary objectives
- Endpoints and estimands

**Interventions & Procedures:**
- Drug products with administration details
- Substances and ingredients
- Medical devices and procedures

**Timeline Visualization:**
- Interactive Cytoscape graph of epochs and encounters
- Node details panel with encounter information
- Execution model overlay with time anchors

**Advanced Views:**
- Execution model details (state machine, visit windows, dosing)
- Provenance explorer with source tracking
- Quality metrics dashboard
- Validation results
- Raw USDM JSON viewer

### Semantic Editing (v7.2.1)

> **âœ… Implemented:** The web UI now supports **semantic editing of USDM data** using JSON Patch (RFC 6902):
> - Edit USDM entities directly in the browser via inline editing
> - Draft/publish workflow with revision tracking
> - Auto-validation on publish (schema + USDM + CORE conformance)
> - Version history and USDM snapshots for rollback
> - Source documents tab (protocol PDF, SAP, sites)
> - Intermediate files browser for extraction artifacts
>
> See [docs/SEMANTIC_EDITING_SPEC.md](docs/SEMANTIC_EDITING_SPEC.md) for full implementation details.

---

## Model Benchmark

SoA extraction tested on Alexion Wilson's Disease protocol (Jan 2026):

| Model | Activities | Timepoints | Ticks | Expansion Phases | Recommendation |
|-------|------------|------------|-------|------------------|----------------|
| **gemini-3-flash** â­ | 36 âœ“ | 24 âœ“ | 216 | 12/12 âœ“ | **Optimized for this release** |
| gemini-2.5-pro | 36 âœ“ | 24 âœ“ | 207 | 12/12 âœ“ | Tested fallback |

**Notes:**
- **gemini-3-flash**: This release is optimized and tuned for Gemini Flash 3. Best balance of speed, accuracy, and cost.
- **gemini-2.5-pro**: Used as automatic fallback for SoA text extraction when Gemini 3 has JSON compliance issues.
- Other provider hooks (OpenAI, Anthropic) exist in `llm_providers.py` for future tuning but are **not currently optimised or tested**.

---

## Project Structure

```
Protocol2USDMv3/
â”œâ”€â”€ main_v3.py                # Entry point (phase registry architecture)
â”œâ”€â”€ llm_config.yaml           # LLM task-optimized parameters
â”œâ”€â”€ llm_providers.py          # Legacy LLM provider (see providers/)
â”œâ”€â”€ providers/                # LLM provider abstraction layer
â”‚   â”œâ”€â”€ base.py               # BaseProvider ABC
â”‚   â”œâ”€â”€ factory.py            # Auto-detect provider from model name
â”‚   â”œâ”€â”€ gemini.py             # GeminiProvider (Vertex AI)
â”‚   â”œâ”€â”€ openai_provider.py    # OpenAIProvider
â”‚   â”œâ”€â”€ anthropic_provider.py # AnthropicProvider
â”‚   â””â”€â”€ tracker.py            # TokenUsageTracker with per-phase cost
â”œâ”€â”€ pipeline/                 # Phase registry architecture
â”‚   â”œâ”€â”€ base_phase.py         # BasePhase class with extract/combine/save
â”‚   â”œâ”€â”€ phase_registry.py     # Phase registration and discovery
â”‚   â”œâ”€â”€ orchestrator.py       # Pipeline orchestration with parallel support
â”‚   â”œâ”€â”€ combiner.py           # combine_to_full_usdm(), USDM defaults
â”‚   â”œâ”€â”€ integrations.py       # SAP/sites integration, content refs
â”‚   â”œâ”€â”€ post_processing.py    # Entity reconciliation, procedure linking
â”‚   â”œâ”€â”€ promotion.py          # Extensionâ†’USDM promotion rules
â”‚   â”œâ”€â”€ integrity.py          # 3-layer referential integrity checker
â”‚   â”œâ”€â”€ regression_gate.py    # Pre-commit structural quality checks
â”‚   â””â”€â”€ phases/               # 14 individual phase implementations
â”œâ”€â”€ core/                     # Core modules
â”‚   â”œâ”€â”€ usdm_schema_loader.py # Official CDISC schema parser
â”‚   â”œâ”€â”€ usdm_types_generated.py # 86+ USDM types (schema-aligned)
â”‚   â”œâ”€â”€ llm_client.py         # LLM client utilities (call_llm, call_llm_with_image)
â”‚   â”œâ”€â”€ constants.py          # Centralized constants (DEFAULT_MODEL, etc.)
â”‚   â”œâ”€â”€ evs_client.py         # NCI EVS API client with 30-day cache
â”‚   â”œâ”€â”€ core_compliance.py    # CORE compliance safety-net (labels, IDs, XHTML)
â”‚   â”œâ”€â”€ terminology_codes.py  # EVS-verified NCI C-codes
â”‚   â”œâ”€â”€ procedure_codes.py    # Multi-system procedure code enricher
â”‚   â”œâ”€â”€ m11_mapping_config.py # M11 section â†” USDM entity mapping
â”‚   â””â”€â”€ reconciliation/       # Entity reconciliation framework
â”œâ”€â”€ extraction/               # Extraction modules
â”‚   â”œâ”€â”€ pipeline_context.py   # PipelineContext with PHASE_FIELD_OWNERSHIP
â”‚   â”œâ”€â”€ header_analyzer.py    # Vision-based SoA structure
â”‚   â”œâ”€â”€ text_extractor.py     # Text-based SoA extraction
â”‚   â”œâ”€â”€ pipeline.py           # SoA extraction pipeline
â”‚   â”œâ”€â”€ execution/            # Execution model extractors
â”‚   â””â”€â”€ */                    # Domain extractors (metadata, eligibility, etc.)
â”œâ”€â”€ rendering/                # M11 document rendering
â”‚   â”œâ”€â”€ m11_renderer.py       # DOCX generation with 7-pass section mapper
â”‚   â”œâ”€â”€ composers.py          # 9 entity composers (synopsis, objectives, etc.)
â”‚   â””â”€â”€ tables.py             # SoA table rendering
â”œâ”€â”€ validation/               # Validation package
â”‚   â”œâ”€â”€ usdm_validator.py     # Official USDM validation
â”‚   â”œâ”€â”€ cdisc_conformance.py  # CDISC CORE conformance
â”‚   â””â”€â”€ m11_conformance.py    # M11 conformance scoring
â”œâ”€â”€ enrichment/               # Terminology enrichment
â”‚   â””â”€â”€ terminology.py        # NCI EVS enrichment
â”œâ”€â”€ tests/                    # 1117 tests (unit + e2e)
â”‚   â”œâ”€â”€ test_extractors.py    # Mocked LLM extractor tests (58)
â”‚   â”œâ”€â”€ test_composers.py     # M11 composer tests (22)
â”‚   â”œâ”€â”€ test_pipeline_context.py # PipelineContext tests (48)
â”‚   â”œâ”€â”€ test_parallel_execution.py # Parallel sub-extractors (13)
â”‚   â”œâ”€â”€ test_async_llm.py     # Async LLM calls (16)
â”‚   â”œâ”€â”€ test_llm_streaming.py # LLM streaming (15)
â”‚   â”œâ”€â”€ test_cache_aware.py   # Cache key generation (19)
â”‚   â”œâ”€â”€ test_evs_chunked_cache.py # EVS chunked cache (17)
â”‚   â”œâ”€â”€ test_e2e_pipeline.py  # E2E integration tests (33)
â”‚   â””â”€â”€ conftest.py           # Shared fixtures, --run-e2e marker
â”œâ”€â”€ scripts/                  # Utility scripts
â”‚   â”œâ”€â”€ extractors/           # Standalone CLI extractors
â”‚   â””â”€â”€ debug/                # Debug utilities
â”œâ”€â”€ testing/                  # Benchmarking tools
â”œâ”€â”€ docs/                     # Architecture documentation
â”œâ”€â”€ web-ui/                   # React/Next.js protocol viewer & editor
â”œâ”€â”€ tools/                    # External tools (CDISC CORE engine)
â”œâ”€â”€ archive/                  # Archived legacy files
â””â”€â”€ output/                   # Pipeline outputs
```

For detailed architecture, see [docs/ARCHITECTURE.md](docs/ARCHITECTURE.md).

---

## Testing

```bash
# Run all unit tests (1117 collected, ~3 min)
python -m pytest tests/ -v

# Run with coverage report
python -m pytest tests/ --cov --cov-report=term-missing

# Run with HTML coverage report
python -m pytest tests/ --cov --cov-report=html
# Open htmlcov/index.html in browser

# Run E2E integration tests (requires recent pipeline output)
python -m pytest tests/test_e2e_pipeline.py --run-e2e -v

# Run specific test modules
python -m pytest tests/test_extractors.py -v      # Mocked LLM extractor tests
python -m pytest tests/test_composers.py -v       # M11 composer tests
python -m pytest tests/test_pipeline_context.py -v # PipelineContext tests
python -m pytest tests/test_pipeline_registry.py -v # Phase registry tests
python -m pytest tests/test_m11_regression.py -v   # M11 renderer tests

# Benchmark models
python testing/benchmark.py <golden.json> <extracted_dir/> [--verbose]
```

### Test Coverage (v7.4)

| Module | Coverage |
|--------|----------|
| `extraction/pipeline_context.py` | 93.6% |
| `validation/m11_conformance.py` | 99.4% |
| `extraction/metadata/schema.py` | 96.6% |
| `extraction/eligibility/schema.py` | 92.1% |
| `rendering/composers.py` | 88.0% |
| `rendering/m11_renderer.py` | 89.6% |
| **Overall** | **42.5%** |

---

## Configuration

### Environment Variables

```bash
# RECOMMENDED: Google Cloud Vertex AI (for Gemini models)
GOOGLE_CLOUD_PROJECT=your-project-id     # Your GCP project
GOOGLE_CLOUD_LOCATION=us-central1        # Region (us-central1, europe-west1, etc.)

# Alternative: Google AI Studio (may have safety restrictions)
GOOGLE_API_KEY=...          # For Gemini via AI Studio (not recommended for clinical)

# Other providers
OPENAI_API_KEY=...          # For GPT models
CLAUDE_API_KEY=...          # For Claude models (Anthropic)

# Required for CDISC conformance validation
CDISC_API_KEY=...           # For CORE rules cache (get from library.cdisc.org)
```

> **âš ï¸ Important:** For clinical protocol extraction, use **Vertex AI** for Gemini models. AI Studio may block medical content even with safety settings disabled.

### Supported Models

**Supported (optimised and tested):**
- `gemini-3-flash` â­ **Recommended** - Pipeline optimised and tuned for this model
- `gemini-2.5-pro` - Tested fallback, used automatically for SoA text extraction

**Future (hooks exist, not yet tuned):**
- `claude-opus-4-5`, `claude-sonnet-4` - Anthropic provider hooks in `llm_providers.py`
- `gpt-5.2`, `gpt-5.1` - OpenAI provider hooks in `llm_providers.py`

> **Note:** Provider abstractions for OpenAI and Anthropic are implemented but prompts and parameters have not been tuned for these models. They are reserved for future support.

---

## Troubleshooting

| Issue | Solution |
|-------|----------|
| API key error | Check `.env` file, restart terminal |
| Gemini blocks content | Use Vertex AI instead of AI Studio (see Configuration) |
| Missing visits | Verify correct SoA pages found (check `4_header_structure.json`) |
| Parse errors | Try `gemini-3-flash` model, check verbose logs |
| Schema errors | Post-processing auto-fixes most issues |
| Safety filter errors | Ensure using Vertex AI with `BLOCK_NONE` settings |

---

## Roadmap / TODO

The following items are planned for upcoming releases:

- [ ] **User Access Management & E-Signatures**: RBAC, authentication, 21 CFR Part 11 e-signatures *(deferred â€” requires user access management)*
- [ ] **Biomedical Concepts**: Add extraction via a separate comprehensive canonical model for standardized concept mapping
- [ ] **Multi-Protocol Comparison**: Compare USDM outputs across protocol versions
- [x] **Structured JSON Logging** (E12): `core/logging_config.py` with JSON/console formatters *(completed v7.4)*
- [x] **Async LLM Calls** (E23): Native async for all 3 providers *(completed v7.4)*
- [x] **LLM Streaming** (E21): StreamChunk + StreamCallback *(completed v7.4)*
- [x] **Parallel Execution Model** (E20): Two-wave ThreadPoolExecutor *(completed v7.4)*
- [x] **Chunked EVS Cache** (E22): Per-code JSON files *(completed v7.4)*
- [x] **Cache-Aware Execution** (E24): Model+prompt hash in keys *(completed v7.4)*
- [x] **Provenance Tracking** (E14): PhaseProvenance for all phases *(completed v7.4)*
- [x] **Prompt Versioning** (E15): SHA-256 hashes in run manifest *(completed v7.4)*
- [x] **ICH M11 Document Rendering**: DOCX generation with 9 entity composers *(completed v7.3)*
- [x] **Testing Infrastructure**: 1117 tests, mocked LLM tests *(completed v7.3â€“v8.0)*
- [x] **Pipeline Decomposition**: combiner/integrations/post_processing/promotion *(completed v7.3)*
- [x] **Web UI Semantic Editing**: JSON Patch editing with draft/publish workflow *(completed v7.2.1)*
- [x] **Execution Model Promotion**: Native USDM entities instead of extensions *(completed v7.2)*
- [x] **Phase Registry Architecture**: `main_v3.py` with parallel execution *(completed v7.1)*
- [x] **Gemini Flash 3 Optimization**: Pipeline optimized for `gemini-3-flash` *(completed v7.0)*
- [x] **Modern Web UI**: Complete React/Next.js revamp from Streamlit *(completed v7.0)*
- [x] **USDM 4.0 Alignment**: All entities at correct locations per `dataStructure.yml` *(completed v7.0)*

---

## License

Contact author for permission to use.

---

## Acknowledgments

This project is, in many ways, a workflow wrapper around the incredible work done by [CDISC](https://www.cdisc.org/) and its volunteers. 

### CDISC & Data4Knowledge

A special thank you to the **Data4Knowledge (D4K) team** and the CDISC DDF/USDM community:

- **[DDF Reference Architecture](https://github.com/cdisc-org/DDF-RA)** - The USDM standard that powers this entire pipeline
- **[CDISC CORE Engine](https://github.com/cdisc-org/cdisc-rules-engine)** - Conformance validation engine and rules
- **[usdm Python Package](https://pypi.org/project/usdm/)** - Official USDM validation library

Most importantly, heartfelt thanks to **Dave Iberson-Hurst**, **Kirsten Walther Langendorf**, and **Johannes Ulander** â€” who have been extraordinarily kind and supportive despite my repeated questions and pestering. Their openness in sharing their work and time enables projects like this to exist.

### Other Resources

- [NCI EVS](https://evs.nci.nih.gov/) for terminology services
