# Timeline Menu - Reviewer Guide

> **Document Purpose:** This document provides a comprehensive overview of the Timeline functionality in the Protocol2USDM Web UI for external reviewers to assess gaps, enhancements, and potential improvements.

---

## 1. Protocol2USDM Project Summary

### What is Protocol2USDM?

Protocol2USDM is an automated pipeline that extracts clinical trial protocol content from PDF documents and structures it into data conformant with the **CDISC USDM v4.0** (Unified Study Definitions Model) standard.

### Core Capabilities

| Capability | Description |
|------------|-------------|
| **Multi-Model LLM Extraction** | Uses Claude Opus 4.5, Gemini 3 Flash, ChatGPT 5.2 for intelligent content extraction |
| **Vision-Validated Extraction** | Text extraction validated against actual PDF images to reduce hallucinations |
| **USDM v4.0 Alignment** | Outputs follow official CDISC schema with proper entity hierarchy |
| **NCI Terminology Enrichment** | Automatic enrichment with official NCI codes via EVS API |
| **Provenance Tracking** | Every extracted cell tagged with source (text/vision/both) for confidence tracking |
| **CDISC CORE Validation** | Built-in conformance checking with local CORE engine |

### Primary Workflow

```
Protocol PDF → LLM Extraction → USDM v4.0 JSON → Web UI Visualization
                    ↓
           Intermediate Files (11_execution_model.json, etc.)
```

### Technology Stack (Web UI)

- **Next.js 16** - React framework with App Router
- **TypeScript** - Type safety
- **Tailwind CSS** - Styling
- **shadcn/ui** - UI components
- **Cytoscape.js** - Timeline graph diagrams
- **Zustand** - State management

---

## 2. Timeline Menu Overview

The **Timeline** tab in the protocol detail page provides two distinct visualization modes:

| View Mode | Technology | Purpose |
|-----------|------------|---------|
| **Execution Model** | React components | Detailed execution model data panels (anchors, visits, conditions, etc.) |
| **Graph View** | Cytoscape.js | Interactive node-based timeline diagram |

Users toggle between views using buttons at the top of the Timeline tab.

---

## 3. Execution Model View (Primary View)

The Execution Model view provides a tabbed interface displaying all temporal and execution-related data extracted from the protocol.

### 3.1 Data Source

Data is loaded from `11_execution_model.json` in the protocol output directory. This file is generated by the execution model extractor during pipeline processing.

**API Endpoint:** `GET /api/protocols/[id]/usdm` → `intermediateFiles.executionModel.data`

### 3.2 Available Tabs

#### 3.2.1 Overview Tab
**Icon:** Activity  
**Purpose:** Dashboard summary of all execution model components

**Displays:**
- Stat cards showing counts for each entity type:
  - Time Anchors count
  - Visit Windows count
  - Conditions count
  - Repetitions count
  - Dosing Regimens count
  - State Machine states count
- Interactive **Timeline Visualization** showing:
  - Horizontal axis with day markers and tick marks
  - Visit windows as green bars (showing window ranges)
  - Visit target days as circular markers
  - Day 1 anchor marker (red line with anchor icon)
  - Hover tooltips with visit details
  - Dynamic scaling based on study duration

**Potential Gaps/Improvements:**
- [ ] No zoom/pan capability on timeline visualization
- [ ] Missing epoch grouping on timeline
- [ ] No activity overlay on timeline
- [ ] Timeline doesn't show relationships between visits

---

#### 3.2.2 Time Anchors Tab
**Icon:** Anchor  
**Purpose:** Display all temporal reference points defined in the protocol

**Data Fields:**
| Field | Description |
|-------|-------------|
| `id` | Unique identifier (e.g., `anchor_1`) |
| `definition` | Human-readable definition of the anchor |
| `anchorType` | Type classification (FirstDose, Baseline, InformedConsent, Randomization, etc.) |
| `timelineId` | Optional reference to associated timeline |
| `dayValue` | Day number if applicable |
| `sourceText` | Original text from protocol |

**Visual Features:**
- Color-coded badges by anchor type:
  - **Blue:** FirstDose
  - **Green:** Baseline
  - **Purple:** InformedConsent
  - **Amber:** Randomization
  - **Gray:** Other types
- Cards with source text expandable

**Potential Gaps/Improvements:**
- [ ] No visual timeline showing anchor relationships
- [ ] Missing link to related visits/encounters
- [ ] No edit capability
- [ ] Anchor types not validated against USDM controlled terminology

---

#### 3.2.3 Visit Windows Tab
**Icon:** Calendar  
**Purpose:** Display all scheduled visits with their timing windows

**Data Fields:**
| Field | Description |
|-------|-------------|
| `id` | Unique identifier (e.g., `visit_1`) |
| `visitName` | Display name of visit |
| `targetDay` | Target study day for visit |
| `targetWeek` | Target week (if applicable) |
| `windowBefore` | Days allowed before target |
| `windowAfter` | Days allowed after target |
| `isRequired` | Whether visit is mandatory |
| `visitNumber` | Sequential visit number |
| `epoch` | Associated study epoch |
| `sourceText` | Original text from protocol |

**Visual Features:**
- Dual view: Table + Timeline visualization
- Required visits highlighted with green badge
- Window ranges shown as green bars on timeline
- Hover tooltips with full visit details

**Potential Gaps/Improvements:**
- [ ] No epoch grouping in table
- [ ] Missing encounter/activity mapping
- [ ] Window deviations not visualized
- [ ] No sorting/filtering controls
- [ ] Week-based scheduling not well represented

---

#### 3.2.4 Conditions Tab
**Icon:** FileText  
**Purpose:** Display footnote conditions and procedural rules

**Data Fields:**
| Field | Description |
|-------|-------------|
| `id` | Unique identifier |
| `conditionType` | Type: general, timing_before, timing_after, frequency_daily, procedure_conditional, etc. |
| `text` | Condition text |
| `footnoteId` | Reference footnote marker (e.g., "(a)", "1.") |
| `structuredCondition` | Parsed structured condition if available |
| `appliesToActivityIds` | List of activities this condition applies to |
| `sourceText` | Original extracted text |

**Visual Features:**
- Grouped by condition type
- Badge showing footnote ID
- Expandable source text

**Potential Gaps/Improvements:**
- [ ] Conditions not linked to SoA cells
- [ ] No structured condition parsing visualization
- [ ] Missing "applies to" activity resolution (shows IDs, not names)
- [ ] Large number of conditions (100+) makes navigation difficult
- [ ] No search/filter functionality
- [ ] Condition types not consistently classified

---

#### 3.2.5 Repetitions Tab
**Icon:** Repeat  
**Purpose:** Display recurring activity patterns

**Data Fields:**
| Field | Description |
|-------|-------------|
| `id` | Unique identifier |
| `type` | Repetition type: Daily, Interval, Continuous |
| `interval` | ISO 8601 duration (e.g., P1D, P7D) |
| `count` | Number of repetitions |
| `startOffset` | Start day offset (ISO 8601) |
| `endOffset` | End day offset (ISO 8601) |
| `activityIds` | Activities that follow this pattern |
| `sourceText` | Original extracted text |

**Visual Features:**
- Color-coded type badges:
  - **Blue:** Daily
  - **Green:** Interval
  - **Purple:** Continuous
- Pattern visualization for bounded repetitions
- Expandable source text

**Potential Gaps/Improvements:**
- [ ] No visual pattern representation on timeline
- [ ] ISO 8601 durations not human-readable
- [ ] Activity IDs not resolved to names
- [ ] Overlapping repetition patterns not visualized
- [ ] No calendar/gantt view of repetitions

---

#### 3.2.6 Dosing Tab
**Icon:** Pill  
**Purpose:** Display treatment dosing regimens

**Data Fields:**
| Field | Description |
|-------|-------------|
| `id` | Unique identifier |
| `treatmentName` | Name of study treatment |
| `frequency` | Dosing frequency (QD, BID, etc.) |
| `route` | Administration route (Oral, IV, etc.) |
| `startDay` | Treatment start day |
| `doseLevels` | Array of dose amounts and units |
| `titrationSchedule` | Titration pattern if applicable |
| `doseModifications` | Modification rules |

**Visual Features:**
- Cards with treatment summaries
- Dose level badges
- Route and frequency indicators
- Titration schedule visualization

**Potential Gaps/Improvements:**
- [ ] No visual dosing timeline
- [ ] Titration not shown as stepped visualization
- [ ] No link to interventions in USDM
- [ ] Dose modifications not structured
- [ ] Missing arm-specific dosing

---

#### 3.2.7 State Machine Tab
**Icon:** GitBranch  
**Purpose:** Display subject flow state diagram

**Data Fields:**
| Field | Description |
|-------|-------------|
| `id` | Unique identifier |
| `initialState` | Starting state (e.g., "Screening") |
| `terminalStates` | End states (Completed, Discontinued, etc.) |
| `states` | All intermediate states |
| `transitions` | State transition rules with triggers |

**Visual Features:**
- Visual state diagram with:
  - Blue initial state
  - Green/red terminal states
  - Dashed borders for terminal states
- Transition table showing from → to → trigger

**Potential Gaps/Improvements:**
- [ ] Not a true flowchart visualization (just boxes)
- [ ] No arrows connecting states
- [ ] Transition triggers not actionable
- [ ] Missing condition-based branching visualization
- [ ] No integration with epochs/encounters

---

#### 3.2.8 Traversal Tab
**Icon:** Clock  
**Purpose:** Display epoch traversal constraints and activity execution types

**Contains Two Sections:**

##### Traversal Constraints
**Data Fields:**
| Field | Description |
|-------|-------------|
| `id` | Unique identifier |
| `requiredSequence` | Ordered list of epoch IDs subjects must follow |
| `allowEarlyExit` | Whether early termination is permitted |
| `exitEpochIds` | Epoch IDs for early exit paths |
| `mandatoryVisits` | Visits that must be completed |
| `sourceText` | Original extracted text |

**Visual Features:**
- Required sequence shown as epoch flow with arrows
- Early exit badge with exit paths
- Mandatory visits as green badges

##### Activity Execution Types
**Data Fields:**
| Field | Description |
|-------|-------------|
| `activityId` | Activity identifier |
| `executionType` | Type: Single, Window, Episode, Recurring |
| `rationale` | Explanation of classification |

**Visual Features:**
- Table view with color-coded execution type badges
- Rationale as truncated text

**Potential Gaps/Improvements:**
- [ ] Epoch IDs not resolved to names
- [ ] Traversal not visualized as flowchart
- [ ] Execution types not linked to SoA activities
- [ ] Missing crossover/parallel arm paths
- [ ] No analysis windows section (referenced but not implemented)

---

## 4. Graph View (Cytoscape.js Timeline)

The Graph View provides an interactive node-based diagram of the study timeline.

### 4.1 Features

| Feature | Description |
|---------|-------------|
| **Drag-and-drop** | Reposition nodes on canvas |
| **Zoom in/out** | Mouse wheel or toolbar buttons |
| **Fit to view** | Auto-fit all nodes in viewport |
| **Export PNG** | Download timeline as image |
| **Node selection** | Click to view node details |
| **Legend** | Color key for node types |

### 4.2 Node Types

| Type | Color | Represents |
|------|-------|------------|
| Epoch | Blue | Study phases |
| Encounter | Green | Visits/timepoints |
| Activity | Purple | Procedures/assessments |
| Edge | Gray | Relationships between nodes |

### 4.3 Toolbar Controls

- **Zoom In** (+)
- **Zoom Out** (-)
- **Fit** (fit all nodes)
- **Reset Layout** (restore default positions)
- **Export PNG** (download image)
- **Node/Edge counts**

### 4.4 Data Source

Graph is built from USDM StudyDesign data using the `toGraphModel` adapter:
- `studyDesign.epochs` → Epoch nodes
- `studyDesign.encounters` → Encounter nodes  
- `studyDesign.activities` → Activity nodes
- Relationships derived from USDM entity references

### 4.5 Potential Gaps/Improvements

- [ ] No temporal positioning (nodes not arranged by day/week)
- [ ] Missing visit windows on edges
- [ ] No epoch swimlanes
- [ ] Activities not grouped by category
- [ ] No timeline axis overlay
- [ ] Edge labels not shown
- [ ] Layout algorithm could be improved for readability
- [ ] No mini-map for navigation
- [ ] Missing keyboard shortcuts

---

## 5. Data Flow Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                      Protocol PDF                                │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                   Extraction Pipeline                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ SoA Extraction  │  │ Metadata/etc.   │  │ Execution Model │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Output Directory                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │ protocol_usdm   │  │ 11_execution_   │  │ 9_final_soa     │  │
│  │     .json       │  │    model.json   │  │    .json        │  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Web UI API                                   │
│        GET /api/protocols/[id]/usdm                              │
│        → Returns: usdm + intermediateFiles.executionModel        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Timeline Components                           │
│  ┌─────────────────────────┐  ┌─────────────────────────────┐   │
│  │   ExecutionModelView    │  │      TimelineView           │   │
│  │   (8 tabbed panels)     │  │   (Cytoscape.js graph)      │   │
│  └─────────────────────────┘  └─────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. Summary of Gaps & Enhancement Opportunities

### High Priority

| Gap | Impact | Suggested Enhancement |
|-----|--------|----------------------|
| No unified timeline view | Users must mentally combine multiple panels | Create integrated Gantt-style timeline with all elements |
| IDs not resolved to names | Poor readability | Add entity resolution layer to display human-readable names |
| No filtering/search | Hard to find specific data | Add search box and filters to each panel |
| Conditions not linked to SoA | Disconnect between footnotes and table | Add bidirectional navigation |

### Medium Priority

| Gap | Impact | Suggested Enhancement |
|-----|--------|----------------------|
| Graph view lacks temporal layout | Nodes don't reflect actual timing | Implement time-based node positioning |
| State machine not a true diagram | Misses visual flow | Use proper flowchart library (dagre, ELK) |
| Repetitions not visualized | Hard to understand patterns | Add Gantt bars for repetition windows |
| No edit capability | Read-only interface | Add authoring mode for corrections |

### Low Priority

| Gap | Impact | Suggested Enhancement |
|-----|--------|----------------------|
| No keyboard shortcuts | Accessibility | Add standard navigation shortcuts |
| Missing mini-map | Large graphs hard to navigate | Add Cytoscape mini-map extension |
| No print view | Can't easily share | Add print-optimized styles |

---

## 7. Testing Recommendations

### Functional Testing

1. **Load protocols with varying complexity** - Test with simple (single-arm) and complex (crossover, adaptive) designs
2. **Verify data accuracy** - Compare displayed values against source JSON files
3. **Test view toggle** - Ensure smooth switching between Execution Model and Graph views
4. **Test hover interactions** - Verify all tooltips display correct information
5. **Test empty states** - Ensure graceful handling when data sections are missing

### Edge Cases

1. Protocols with no execution model extracted
2. Protocols with very long timelines (365+ days)
3. Protocols with many conditions (100+)
4. Protocols with missing optional fields

### Performance Testing

1. Load time for large execution models
2. Graph rendering with 100+ nodes
3. Timeline visualization with 50+ visits

---

## 8. Files Reference

| File | Purpose |
|------|---------|
| `web-ui/components/timeline/ExecutionModelView.tsx` | Main execution model component with all panels |
| `web-ui/components/timeline/TimelineView.tsx` | Cytoscape graph wrapper |
| `web-ui/components/timeline/TimelineCanvas.tsx` | Cytoscape canvas component |
| `web-ui/components/timeline/TimelineToolbar.tsx` | Graph controls and legend |
| `web-ui/app/protocols/[id]/page.tsx` | Protocol page with Timeline tab integration |
| `web-ui/lib/adapters/toGraphModel.ts` | USDM to graph model adapter |
| `output/*/11_execution_model.json` | Execution model extraction output |

---

## 9. Contact & Feedback

Please submit your review findings including:
- **Identified gaps** with severity rating (High/Medium/Low)
- **Enhancement suggestions** with priority
- **UI/UX feedback** for usability improvements
- **Data accuracy issues** with specific examples

---

*Document generated: January 2026*  
*Protocol2USDM Version: v7.2*
